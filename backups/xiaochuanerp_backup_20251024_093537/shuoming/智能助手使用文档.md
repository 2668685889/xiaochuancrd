# 小川ERP智能助手使用文档

## 概述

小川ERP智能助手是一个基于大模型的智能问数系统，支持自然语言查询进销存数据。用户可以通过简单的自然语言描述来查询和分析企业数据，无需编写复杂的SQL语句。

## 功能特性

### 核心功能
- **自然语言查询**：使用中文自然语言描述查询需求
- **智能SQL生成**：自动将自然语言转换为SQL查询语句
- **数据可视化**：查询结果支持图表展示
- **会话管理**：支持多轮对话和会话历史
- **多数据源支持**：支持MySQL数据库查询

### 支持的数据分析场景
- 产品销售分析
- 客户活跃度分析  
- 库存预警管理
- 供应商评估
- 销售趋势分析
- 业务报表生成

## 系统架构

### 技术栈
- **前端**：React + TypeScript + Vite + Tailwind CSS
- **后端**：FastAPI + SQLAlchemy + MySQL
- **AI模型**：DeepSeek、通义千问、ChatGLM等国产模型
- **数据库**：MySQL 8.0+

### 部署架构
```
前端 (localhost:3001) ←→ 后端API (localhost:8000) ←→ MySQL数据库 (localhost:3306)
```

## 快速开始

### 环境要求
- Python 3.8+
- Node.js 16+
- MySQL 8.0+

### 启动步骤

1. **启动后端服务**
```bash
cd /Users/hui/trae/xiaochuanerp/xiaochuancrd/backend
python run.py
```

2. **启动前端服务**
```bash
cd /Users/hui/trae/xiaochuanerp/xiaochuancrd/frontend
npm run dev
```

3. **访问系统**
- 前端地址：http://localhost:3001
- 后端API：http://localhost:8000

## 使用指南

### 基本查询

#### 1. 产品相关查询
```
- "查询所有产品信息"
- "查看库存量低于安全库存的产品"
- "统计各类产品的销售数量"
- "查询价格最高的前10个产品"
```

#### 2. 客户相关查询
```
- "查询最近一个月有购买记录的客户"
- "统计客户购买频次"
- "查询客户消费金额排名"
- "分析客户地域分布"
```

#### 3. 销售分析
```
- "统计本月销售总额"
- "分析销售趋势"
- "查询热销产品排行"
- "分析销售渠道效果"
```

#### 4. 库存管理
```
- "查询库存预警产品"
- "统计库存周转率"
- "分析库存成本"
- "查询需要补货的产品"
```

### 高级功能

#### 会话管理
- 系统支持多轮对话，可以基于上下文进行连续查询
- 会话历史自动保存，支持查看历史对话
- 可以创建多个独立的会话主题

#### 数据可视化
- 查询结果支持表格和图表展示
- 支持柱状图、折线图、饼图等多种图表类型
- 图表数据可导出为图片或Excel格式

#### 智能分析
- 自动识别业务场景和查询意图
- 提供数据洞察和建议
- 支持趋势预测和异常检测

## API接口文档

### 智能助手聊天接口

**端点**：`POST /api/v1/smart-assistant/chat`

**请求参数**：
```json
{
  "message": "查询所有产品信息",
  "session_id": "optional-session-id"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "response": "🔍 **SQLBot查询结果**...",
    "session_id": "session-123",
    "timestamp": "2024-01-01T10:00:00Z"
  },
  "message": "聊天响应成功"
}
```

### 数据库配置接口

**端点**：`GET /api/v1/smart-assistant/database-config`

**响应示例**：
```json
{
  "success": true,
  "data": {
    "databases": [
      {
        "host": "localhost",
        "port": 3306,
        "database": "xiaochuanERP",
        "username": "root",
        "status": "connected"
      }
    ]
  },
  "message": "数据库配置获取成功"
}
```

### 模型配置接口

**端点**：`GET /api/v1/smart-assistant/model-config`

**响应示例**：
```json
{
  "success": true,
  "data": {
    "models": [
      {
        "id": "deepseek-chat",
        "name": "DeepSeek Chat",
        "provider": "deepseek",
        "status": "available"
      }
    ],
    "selected_model": "deepseek-chat"
  },
  "message": "模型配置获取成功"
}
```

## 数据库结构

### 核心数据表

#### products (产品表)
- `product_id` - 产品ID
- `product_name` - 产品名称
- `category` - 产品分类
- `price` - 价格
- `current_stock` - 当前库存
- `safety_stock` - 安全库存

#### customers (客户表)
- `customer_id` - 客户ID
- `customer_name` - 客户名称
- `contact_info` - 联系信息
- `region` - 地区

#### sales_orders (销售订单表)
- `order_id` - 订单ID
- `customer_id` - 客户ID
- `order_date` - 订单日期
- `total_amount` - 订单金额
- `status` - 订单状态

#### inventory_records (库存记录表)
- `record_id` - 记录ID
- `product_id` - 产品ID
- `change_type` - 变动类型
- `quantity` - 数量
- `timestamp` - 时间戳

## 最佳实践

### 查询优化建议

1. **明确查询目标**
   - 使用具体的业务术语
   - 明确时间范围（如"最近一个月"）
   - 指定排序方式（如"按销售额降序"）

2. **避免模糊描述**
   - ❌ "看看数据"
   - ✅ "查询本月销售总额"

3. **合理使用过滤条件**
   - 指定具体的产品类别
   - 明确客户群体
   - 设置合理的日期范围

### 性能优化

1. **查询复杂度控制**
   - 避免过于复杂的多表关联查询
   - 合理使用分页查询
   - 对大数据量查询使用异步处理

2. **缓存策略**
   - 常用查询结果缓存
   - 会话状态缓存
   - 模型响应缓存

## 故障排除

### 常见问题

#### 1. 查询无响应
- 检查后端服务是否正常运行
- 验证数据库连接状态
- 查看服务日志获取详细错误信息

#### 2. SQL生成错误
- 确认查询语句的语法正确性
- 检查表名和字段名的准确性
- 验证数据库权限设置

#### 3. 会话丢失
- 检查会话存储配置
- 验证会话ID的传递
- 查看会话超时设置

### 日志查看

#### 后端日志
```bash
# 查看后端服务日志
tail -f /Users/hui/trae/xiaochuanerp/xiaochuancrd/backend/logs/app.log
```

#### 数据库日志
```bash
# 查看MySQL错误日志
tail -f /var/log/mysql/error.log
```

## 安全说明

### 数据安全
- 数据库连接使用加密传输
- 敏感信息（如API密钥）加密存储
- 用户权限分级管理

### 访问控制
- API接口需要身份验证
- 数据库操作权限最小化原则
- 查询结果数据脱敏处理

## 扩展开发

### 自定义查询模板

可以扩展系统的查询模板，支持更多业务场景：

```python
# 在 app/services/sqlbot_service.py 中添加自定义模板
CUSTOM_TEMPLATES = {
    "销售分析": "分析{time_range}的销售数据，按{group_by}分组统计",
    "库存预警": "查询库存量低于安全库存{threshold}%的产品"
}
```

### 新增数据源

支持连接其他数据库类型：

```python
# 在 app/core/database.py 中配置新数据源
ADDITIONAL_DATABASES = {
    "warehouse": "mysql+aiomysql://user:pass@host/warehouse_db",
    "analytics": "postgresql+asyncpg://user:pass@host/analytics_db"
}
```

## 版本历史

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持自然语言查询
- 基础会话管理功能
- 数据可视化展示

## 技术支持

如有问题或建议，请联系：
- 技术支持邮箱：support@xiaochuanerp.com
- 项目文档：https://docs.xiaochuanerp.com
- GitHub仓库：https://github.com/xiaochuanerp/smart-assistant

---

*本文档最后更新：2024年1月1日*