# 进销存管理系统 - 数据库设计文档

## 数据库概述

### 数据库类型
- **数据库**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **存储引擎**: InnoDB

### 设计原则
1. **规范化设计**: 遵循第三范式，减少数据冗余
2. **性能优化**: 合理使用索引，优化查询性能
3. **数据完整性**: 使用约束保证数据一致性
4. **扩展性**: 支持未来功能扩展
5. **安全性**: 敏感数据加密存储

## 表结构设计

### 用户表 (users)

#### 表结构
```sql
CREATE TABLE users (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('admin', 'manager', 'user') NOT NULL DEFAULT 'user',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键，全局唯一标识 |
| username | VARCHAR(50) | 是 | - | 用户名，唯一 |
| email | VARCHAR(100) | 是 | - | 邮箱地址，唯一 |
| password_hash | VARCHAR(255) | 是 | - | 密码哈希值 |
| role | ENUM | 是 | 'user' | 用户角色 |
| is_active | BOOLEAN | 是 | TRUE | 是否激活 |
| last_login_at | TIMESTAMP | 否 | NULL | 最后登录时间 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 否 | NULL | 软删除时间 |

#### 索引设计
```sql
-- 唯一索引
UNIQUE INDEX uk_users_username (username);
UNIQUE INDEX uk_users_email (email);

-- 普通索引
INDEX idx_users_role (role);
INDEX idx_users_is_active (is_active);
INDEX idx_users_created_at (created_at);
```

### 供应商表 (suppliers)

#### 表结构
```sql
CREATE TABLE suppliers (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    supplier_name VARCHAR(100) NOT NULL,
    supplier_code VARCHAR(50) NOT NULL UNIQUE,
    contact_person VARCHAR(50),
    phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键 |
| supplier_name | VARCHAR(100) | 是 | - | 供应商名称 |
| supplier_code | VARCHAR(50) | 是 | - | 供应商编码，唯一 |
| contact_person | VARCHAR(50) | 否 | NULL | 联系人 |
| phone | VARCHAR(20) | 否 | NULL | 联系电话 |
| email | VARCHAR(100) | 否 | NULL | 邮箱地址 |
| address | TEXT | 否 | NULL | 地址信息 |
| is_active | BOOLEAN | 是 | TRUE | 是否激活 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 否 | NULL | 软删除时间 |

#### 索引设计
```sql
-- 唯一索引
UNIQUE INDEX uk_suppliers_code (supplier_code);

-- 普通索引
INDEX idx_suppliers_name (supplier_name);
INDEX idx_suppliers_is_active (is_active);
INDEX idx_suppliers_created_at (created_at);
```

### 产品表 (products)

#### 表结构
```sql
CREATE TABLE products (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    product_name VARCHAR(100) NOT NULL,
    product_code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    unit_price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    current_quantity INT NOT NULL DEFAULT 0,
    min_quantity INT NOT NULL DEFAULT 0,
    max_quantity INT NOT NULL DEFAULT 0,
    supplier_uuid CHAR(36) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (supplier_uuid) REFERENCES suppliers(uuid) ON DELETE RESTRICT
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键 |
| product_name | VARCHAR(100) | 是 | - | 产品名称 |
| product_code | VARCHAR(50) | 是 | - | 产品编码，唯一 |
| description | TEXT | 否 | NULL | 产品描述 |
| unit_price | DECIMAL(10,2) | 是 | 0.00 | 单价 |
| current_quantity | INT | 是 | 0 | 当前库存数量 |
| min_quantity | INT | 是 | 0 | 最小库存量 |
| max_quantity | INT | 是 | 0 | 最大库存量 |
| supplier_uuid | CHAR(36) | 是 | - | 供应商外键 |
| is_active | BOOLEAN | 是 | TRUE | 是否激活 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 否 | NULL | 软删除时间 |

#### 索引设计
```sql
-- 唯一索引
UNIQUE INDEX uk_products_code (product_code);

-- 普通索引
INDEX idx_products_name (product_name);
INDEX idx_products_supplier (supplier_uuid);
INDEX idx_products_is_active (is_active);
INDEX idx_products_quantity (current_quantity);
INDEX idx_products_created_at (created_at);

-- 复合索引
INDEX idx_products_stock_status (current_quantity, min_quantity, max_quantity);
```

### 库存记录表 (inventory_records)

#### 表结构
```sql
CREATE TABLE inventory_records (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    product_uuid CHAR(36) NOT NULL,
    change_type ENUM('IN', 'OUT', 'ADJUST') NOT NULL,
    quantity_change INT NOT NULL,
    current_quantity INT NOT NULL,
    remark TEXT,
    record_date DATE NOT NULL,
    created_by CHAR(36) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (product_uuid) REFERENCES products(uuid) ON DELETE RESTRICT,
    FOREIGN KEY (created_by) REFERENCES users(uuid) ON DELETE RESTRICT
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键 |
| product_uuid | CHAR(36) | 是 | - | 产品外键 |
| change_type | ENUM | 是 | - | 变动类型 |
| quantity_change | INT | 是 | - | 变动数量 |
| current_quantity | INT | 是 | - | 变动后库存 |
| remark | TEXT | 否 | NULL | 备注信息 |
| record_date | DATE | 是 | - | 记录日期 |
| created_by | CHAR(36) | 是 | - | 操作人外键 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引设计
```sql
-- 普通索引
INDEX idx_inventory_product (product_uuid);
INDEX idx_inventory_change_type (change_type);
INDEX idx_inventory_record_date (record_date);
INDEX idx_inventory_created_by (created_by);
INDEX idx_inventory_created_at (created_at);

-- 复合索引
INDEX idx_inventory_product_date (product_uuid, record_date);
INDEX idx_inventory_date_type (record_date, change_type);
```

### 产品分类表 (product_categories)

#### 表结构
```sql
CREATE TABLE product_categories (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    category_name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    parent_uuid CHAR(36) NULL,
    sort_order INT NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (parent_uuid) REFERENCES product_categories(uuid) ON DELETE SET NULL
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键 |
| category_name | VARCHAR(50) | 是 | - | 分类名称，唯一 |
| description | TEXT | 否 | NULL | 分类描述 |
| parent_uuid | CHAR(36) | 否 | NULL | 父级分类 |
| sort_order | INT | 是 | 0 | 排序顺序 |
| is_active | BOOLEAN | 是 | TRUE | 是否激活 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 更新时间 |

#### 索引设计
```sql
-- 唯一索引
UNIQUE INDEX uk_categories_name (category_name);

-- 普通索引
INDEX idx_categories_parent (parent_uuid);
INDEX idx_categories_sort_order (sort_order);
INDEX idx_categories_is_active (is_active);
```

### 产品分类关联表 (product_category_relations)

#### 表结构
```sql
CREATE TABLE product_category_relations (
    uuid CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    product_uuid CHAR(36) NOT NULL,
    category_uuid CHAR(36) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (product_uuid) REFERENCES products(uuid) ON DELETE CASCADE,
    FOREIGN KEY (category_uuid) REFERENCES product_categories(uuid) ON DELETE CASCADE,
    UNIQUE KEY uk_product_category (product_uuid, category_uuid)
);
```

#### 字段说明
| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| uuid | CHAR(36) | 是 | UUID() | 主键 |
| product_uuid | CHAR(36) | 是 | - | 产品外键 |
| category_uuid | CHAR(36) | 是 | - | 分类外键 |
| created_at | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引设计
```sql
-- 唯一索引
UNIQUE INDEX uk_product_category (product_uuid, category_uuid);

-- 普通索引
INDEX idx_relations_product (product_uuid);
INDEX idx_relations_category (category_uuid);
```

## 视图设计

### 产品详情视图 (v_product_details)

#### 视图定义
```sql
CREATE VIEW v_product_details AS
SELECT 
    p.uuid,
    p.product_name,
    p.product_code,
    p.description,
    p.unit_price,
    p.current_quantity,
    p.min_quantity,
    p.max_quantity,
    p.is_active,
    p.created_at,
    p.updated_at,
    
    s.uuid AS supplier_uuid,
    s.supplier_name,
    s.supplier_code,
    s.contact_person,
    s.phone,
    s.email,
    
    -- 库存状态
    CASE 
        WHEN p.current_quantity <= p.min_quantity THEN 'LOW_STOCK'
        WHEN p.current_quantity >= p.max_quantity THEN 'HIGH_STOCK'
        ELSE 'NORMAL'
    END AS stock_status,
    
    -- 库存价值
    (p.unit_price * p.current_quantity) AS stock_value
    
FROM products p
LEFT JOIN suppliers s ON p.supplier_uuid = s.uuid
WHERE p.deleted_at IS NULL AND s.deleted_at IS NULL;
```

### 库存汇总视图 (v_inventory_summary)

#### 视图定义
```sql
CREATE VIEW v_inventory_summary AS
SELECT 
    p.uuid AS product_uuid,
    p.product_name,
    p.product_code,
    p.unit_price,
    p.current_quantity,
    p.min_quantity,
    p.max_quantity,
    
    -- 库存价值
    (p.unit_price * p.current_quantity) AS stock_value,
    
    -- 库存状态
    CASE 
        WHEN p.current_quantity <= p.min_quantity THEN 'LOW_STOCK'
        WHEN p.current_quantity >= p.max_quantity THEN 'HIGH_STOCK'
        ELSE 'NORMAL'
    END AS stock_status,
    
    -- 供应商信息
    s.supplier_name,
    s.supplier_code
    
FROM products p
LEFT JOIN suppliers s ON p.supplier_uuid = s.uuid
WHERE p.deleted_at IS NULL AND s.deleted_at IS NULL
AND p.is_active = TRUE;
```

### 库存变动统计视图 (v_inventory_statistics)

#### 视图定义
```sql
CREATE VIEW v_inventory_statistics AS
SELECT 
    p.uuid AS product_uuid,
    p.product_name,
    p.product_code,
    
    -- 今日入库数量
    COALESCE(SUM(CASE WHEN ir.record_date = CURDATE() AND ir.change_type = 'IN' THEN ir.quantity_change ELSE 0 END), 0) AS today_in,
    
    -- 今日出库数量
    COALESCE(SUM(CASE WHEN ir.record_date = CURDATE() AND ir.change_type = 'OUT' THEN ir.quantity_change ELSE 0 END), 0) AS today_out,
    
    -- 本月入库数量
    COALESCE(SUM(CASE WHEN YEAR(ir.record_date) = YEAR(CURDATE()) AND MONTH(ir.record_date) = MONTH(CURDATE()) AND ir.change_type = 'IN' THEN ir.quantity_change ELSE 0 END), 0) AS month_in,
    
    -- 本月出库数量
    COALESCE(SUM(CASE WHEN YEAR(ir.record_date) = YEAR(CURDATE()) AND MONTH(ir.record_date) = MONTH(CURDATE()) AND ir.change_type = 'OUT' THEN ir.quantity_change ELSE 0 END), 0) AS month_out
    
FROM products p
LEFT JOIN inventory_records ir ON p.uuid = ir.product_uuid
WHERE p.deleted_at IS NULL
AND p.is_active = TRUE
GROUP BY p.uuid, p.product_name, p.product_code;
```

## 存储过程设计

### 更新产品库存存储过程

#### 存储过程定义
```sql
DELIMITER //

CREATE PROCEDURE sp_update_product_quantity(
    IN p_product_uuid CHAR(36),
    IN p_change_type ENUM('IN', 'OUT', 'ADJUST'),
    IN p_quantity_change INT,
    IN p_remark TEXT,
    IN p_record_date DATE,
    IN p_created_by CHAR(36)
)
BEGIN
    DECLARE current_qty INT DEFAULT 0;
    DECLARE new_qty INT DEFAULT 0;
    
    -- 获取当前库存
    SELECT current_quantity INTO current_qty 
    FROM products 
    WHERE uuid = p_product_uuid AND deleted_at IS NULL;
    
    -- 计算新库存
    CASE p_change_type
        WHEN 'IN' THEN SET new_qty = current_qty + p_quantity_change;
        WHEN 'OUT' THEN 
            IF current_qty < p_quantity_change THEN
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '库存不足';
            ELSE
                SET new_qty = current_qty - p_quantity_change;
            END IF;
        WHEN 'ADJUST' THEN SET new_qty = p_quantity_change;
    END CASE;
    
    -- 更新产品库存
    UPDATE products 
    SET current_quantity = new_qty, updated_at = CURRENT_TIMESTAMP
    WHERE uuid = p_product_uuid;
    
    -- 插入库存记录
    INSERT INTO inventory_records (
        product_uuid, change_type, quantity_change, 
        current_quantity, remark, record_date, created_by
    ) VALUES (
        p_product_uuid, p_change_type, p_quantity_change,
        new_qty, p_remark, p_record_date, p_created_by
    );
    
END //

DELIMITER ;
```

### 获取库存预警存储过程

#### 存储过程定义
```sql
DELIMITER //

CREATE PROCEDURE sp_get_inventory_alerts()
BEGIN
    -- 低库存预警
    SELECT 
        'LOW_STOCK' AS alert_type,
        p.uuid AS product_uuid,
        p.product_name,
        p.product_code,
        p.current_quantity,
        p.min_quantity,
        'HIGH' AS severity
    FROM products p
    WHERE p.deleted_at IS NULL 
    AND p.is_active = TRUE
    AND p.current_quantity <= p.min_quantity
    
    UNION ALL
    
    -- 高库存预警
    SELECT 
        'HIGH_STOCK' AS alert_type,
        p.uuid AS product_uuid,
        p.product_name,
        p.product_code,
        p.current_quantity,
        p.max_quantity,
        'LOW' AS severity
    FROM products p
    WHERE p.deleted_at IS NULL 
    AND p.is_active = TRUE
    AND p.current_quantity >= p.max_quantity
    AND p.max_quantity > 0;
    
END //

DELIMITER ;
```

## 触发器设计

### 库存记录触发器

#### 插入前触发器
```sql
DELIMITER //

CREATE TRIGGER tr_before_insert_inventory_record
BEFORE INSERT ON inventory_records
FOR EACH ROW
BEGIN
    -- 验证产品存在且未删除
    IF NOT EXISTS (SELECT 1 FROM products WHERE uuid = NEW.product_uuid AND deleted_at IS NULL) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '产品不存在或已被删除';
    END IF;
    
    -- 验证操作人存在且未删除
    IF NOT EXISTS (SELECT 1 FROM users WHERE uuid = NEW.created_by AND deleted_at IS NULL) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '操作人不存在或已被删除';
    END IF;
    
    -- 设置记录日期默认值
    IF NEW.record_date IS NULL THEN
        SET NEW.record_date = CURDATE();
    END IF;
    
END //

DELIMITER ;
```

### 产品删除触发器

#### 删除前触发器
```sql
DELIMITER //

CREATE TRIGGER tr_before_delete_product
BEFORE UPDATE ON products
FOR EACH ROW
BEGIN
    -- 软删除时检查是否有库存记录
    IF NEW.deleted_at IS NOT NULL AND OLD.deleted_at IS NULL THEN
        IF EXISTS (SELECT 1 FROM inventory_records WHERE product_uuid = NEW.uuid) THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '产品存在库存记录，无法删除';
        END IF;
    END IF;
END //

DELIMITER ;
```

## 数据字典

### 枚举类型定义

#### 用户角色 (user_roles)
| 值 | 描述 |
|----|------|
| admin | 系统管理员 |
| manager | 经理 |
| user | 普通用户 |

#### 库存变动类型 (inventory_change_types)
| 值 | 描述 |
|----|------|
| IN | 入库 |
| OUT | 出库 |
| ADJUST | 调整 |

#### 库存状态 (stock_status)
| 值 | 描述 |
|----|------|
| LOW_STOCK | 低库存 |
| HIGH_STOCK | 高库存 |
| NORMAL | 正常库存 |

### 业务规则

#### 库存数量规则
- 当前库存数量不能为负数
- 最小库存量 ≤ 最大库存量
- 入库数量必须为正数
- 出库数量不能超过当前库存

#### 编码规则
- 产品编码：唯一，最大长度50字符
- 供应商编码：唯一，最大长度50字符
- 分类名称：唯一，最大长度50字符

#### 时间规则
- 创建时间：自动设置为当前时间
- 更新时间：自动更新为当前时间
- 记录日期：不能为未来日期

## 性能优化策略

### 索引优化
1. **主键索引**: 所有表使用UUID作为主键
2. **唯一索引**: 编码字段建立唯一索引
3. **复合索引**: 常用查询条件组合建立索引
4. **外键索引**: 所有外键字段建立索引

### 查询优化
1. **分页查询**: 使用LIMIT和OFFSET进行分页
2. **条件过滤**: 合理使用WHERE条件减少数据量
3. **连接优化**: 使用INNER JOIN替代子查询
4. **视图使用**: 复杂查询使用视图封装

### 数据归档
1. **历史数据**: 定期归档历史库存记录
2. **日志清理**: 定期清理操作日志
3. **备份策略**: 定期备份重要数据

## 安全设计

### 数据加密
1. **密码加密**: 使用bcrypt加密用户密码
2. **敏感信息**: 联系方式等敏感信息加密存储
3. **传输加密**: 使用HTTPS传输数据

### 权限控制
1. **角色权限**: 基于角色的访问控制
2. **数据隔离**: 用户只能访问授权数据
3. **操作审计**: 记录所有重要操作

### 数据验证
1. **输入验证**: 所有输入数据验证格式
2. **业务规则**: 应用层验证业务规则
3. **数据库约束**: 数据库层实施约束

## 备份和恢复

### 备份策略
1. **全量备份**: 每周执行一次全量备份
2. **增量备份**: 每天执行增量备份
3. **日志备份**: 实时备份事务日志

### 恢复策略
1. **灾难恢复**: 制定灾难恢复计划
2. **数据恢复**: 支持按时间点恢复
3. **测试恢复**: 定期测试恢复流程

## 监控和维护

### 性能监控
1. **查询性能**: 监控慢查询
2. **连接数**: 监控数据库连接数
3. **空间使用**: 监控磁盘空间使用

### 维护任务
1. **索引重建**: 定期重建碎片化索引
2. **统计信息**: 更新统计信息
3. **空间清理**: 清理临时文件和日志

## 扩展性设计

### 水平扩展
1. **读写分离**: 支持主从复制
2. **分库分表**: 支持数据分片
3. **缓存层**: 支持Redis缓存

### 功能扩展
1. **插件架构**: 支持功能插件
2. **API扩展**: 支持API版本管理
3. **数据迁移**: 支持平滑数据迁移