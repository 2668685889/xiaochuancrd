# 智能助手数据库配置集成文档

## 概述

本文档描述了如何将智能助手的模型配置集成到数据库中，实现动态配置管理，提高系统的灵活性和可维护性。

## 实现的功能

1. **数据库模型配置**：将DeepSeek API配置存储在数据库的`assistants`表中，支持不同工作空间的独立配置
2. **MCP服务器优化**：修改MCP服务器实现，使其从数据库读取模型配置而不是使用硬编码配置
3. **工作空间支持**：确保智能助手路由正确传递工作空间ID，实现多租户支持
4. **动态配置更新**：支持通过数据库动态更新模型配置，无需重启服务

## 技术实现

### 1. 数据库配置

在`assistants`表中添加了以下字段：
- `model_provider`: 模型提供商（如"deepseek"）
- `model_name`: 模型名称（如"deepseek-chat"）
- `api_key`: API密钥
- `api_base`: API基础URL
- `workspace_id`: 工作空间ID，用于多租户隔离

### 2. MCP服务器修改

修改了`mcp_mysql_service.py`中的`_initialize_deepseek_with_config`方法，使其从数据库读取配置：

```python
async def _initialize_deepseek_with_config(self, workspace_id: str = "default"):
    """使用数据库中的配置初始化DeepSeek客户端"""
    try:
        # 从数据库获取模型配置
        result = await self.db.execute(
            select(AssistantModel).where(
                AssistantModel.workspace_id == workspace_id,
                AssistantModel.is_active == True
            )
        )
        assistant_config = result.scalars().first()
        
        if assistant_config:
            # 使用数据库配置初始化DeepSeek客户端
            self.deepseek_client = OpenAI(
                api_key=assistant_config.api_key,
                base_url=assistant_config.api_base
            )
            # 设置其他配置...
        else:
            # 使用默认配置
            self.deepseek_client = OpenAI(
                api_key=settings.DEEPSEEK_API_KEY,
                base_url=settings.DEEPSEEK_API_BASE
            )
    except Exception as e:
        logger.error(f"初始化DeepSeek客户端失败: {str(e)}")
        # 使用默认配置作为后备
```

### 3. 智能助手路由优化

修改了`mcp_server.py`中的`natural_language_query`函数，确保正确传递工作空间ID：

```python
async def natural_language_query(
    request: NaturalLanguageQueryRequest,
    db: AsyncSession = Depends(get_db)
):
    """自然语言查询接口"""
    try:
        # 更新工作空间ID
        workspace_id = request.workspace_id or "default"
        mcp_service.workspace_id = workspace_id
        
        # 重新初始化DeepSeek服务以使用新的工作空间配置
        await mcp_service._initialize_deepseek_with_config(workspace_id)
        
        # 处理查询...
```

### 4. 智能助手API路由修复

修复了`smart_assistant.py`中的`query_data`路由，确保正确实例化MCPService：

```python
# 创建智能助手服务实例（MCPService不需要数据库连接参数）
mcp_service = MCPService()

# 执行数据查询，传递工作空间ID
query_result = await mcp_service.process_chat_message(
    message=query,
    workspace_id=workspace_id
)
```

## 测试结果

1. **MCP服务器测试**：成功从数据库读取配置并处理查询
2. **智能助手API测试**：成功通过API路由处理查询并返回结果
3. **工作空间隔离测试**：不同工作空间的配置可以独立管理

## 使用方法

### 1. 配置模型

在数据库的`assistants`表中插入或更新配置：

```sql
INSERT INTO assistants (name, description, model_provider, model_name, api_key, api_base, workspace_id, is_active, created_at, updated_at)
VALUES (
    '默认助手',
    '系统默认智能助手',
    'deepseek',
    'deepseek-chat',
    'your_api_key',
    'https://api.deepseek.com/v1',
    'default',
    TRUE,
    NOW(),
    NOW()
);
```

### 2. 使用API

通过智能助手API进行查询：

```bash
curl -X POST "http://localhost:8080/api/v1/smart-assistant/query" \
  -G \
  -d "query=查询所有商品信息" \
  -d "data_source=database" \
  -d "workspace_id=default"
```

## 优势

1. **灵活性**：可以通过数据库动态调整模型配置，无需修改代码或重启服务
2. **多租户支持**：不同工作空间可以使用不同的模型配置
3. **可维护性**：配置集中管理，易于维护和监控
4. **扩展性**：可以轻松添加新的模型提供商和配置选项

## 后续优化建议

1. 添加配置缓存机制，减少数据库查询次数
2. 实现配置版本管理，支持配置回滚
3. 添加配置变更通知机制
4. 实现配置热更新，无需重启服务即可应用新配置

## 总结

通过将智能助手的模型配置集成到数据库中，我们实现了配置的动态管理和多租户支持，提高了系统的灵活性和可维护性。这一改进使得系统能够更好地适应不同场景的需求，为未来的功能扩展奠定了基础。