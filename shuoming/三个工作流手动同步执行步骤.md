# 三个工作流手动同步执行步骤说明

## 问题背景

在引入三个独立工作流ID（新增、更新、删除）后，手动同步功能出现了失败。这是因为原有的手动同步逻辑仍然使用单一的工作流ID，没有正确处理新的三个独立工作流ID配置。

## 修复内容

我已经修复了以下关键组件，确保手动同步功能能够正确处理三个独立工作流ID：

### 1. CozeService.trigger_manual_sync 方法
- **修复前**: 仅使用 `coze_workflow_id` 字段
- **修复后**: 优先使用 `coze_workflow_id_insert`（新增操作工作流ID），如果不存在则依次尝试 `coze_workflow_id_update`、`coze_workflow_id_delete`，最后回退到 `coze_workflow_id`

### 2. CDCService._process_changes_for_config 方法
- **修复前**: 仅使用 `coze_workflow_id` 字段
- **修复后**: 根据数据变化的操作类型（INSERT/UPDATE/DELETE）智能选择对应的工作流ID

### 3. 配置加载逻辑
- **修复前**: 只加载 `coze_workflow_id` 字段
- **修复后**: 同时加载三个独立工作流ID字段到内存配置中

## 手动同步的正确执行步骤

### 步骤1：检查同步配置
在点击"手动同步"按钮前，请确保：

1. **同步配置已启用**：配置的"启用"开关必须打开
2. **至少设置一个有效的工作流ID**：
   - 优先设置 `coze_workflow_id_insert`（新增操作工作流ID）
   - 或者设置 `coze_workflow_id_update`、`coze_workflow_id_delete`
   - 或者保留原有的 `coze_workflow_id` 作为兼容性保障

### 步骤2：执行手动同步

1. **点击"手动同步"按钮**：系统会自动选择最合适的工作流ID
2. **选择优先级**：
   - 如果设置了 `coze_workflow_id_insert`，优先使用该ID
   - 否则使用 `coze_workflow_id_update`
   - 否则使用 `coze_workflow_id_delete`
   - 最后回退到 `coze_workflow_id`

### 步骤3：监控同步状态

1. **查看控制台日志**：系统会输出详细的调试信息，包括：
   - 使用的具体工作流ID
   - 表数据获取情况
   - 同步进度和结果

2. **观察界面反馈**：
   - 成功时会显示"同步完成"提示
   - 失败时会显示具体的错误信息

## 工作流ID选择策略

### 手动同步场景
对于手动同步，系统采用以下选择策略：

```
工作流ID选择优先级：
1. coze_workflow_id_insert（新增操作工作流ID）
2. coze_workflow_id_update（更新操作工作流ID）
3. coze_workflow_id_delete（删除操作工作流ID）
4. coze_workflow_id（通用工作流ID，向后兼容）
```

**理由**：手动同步通常用于全量数据同步，类似于"新增"操作，因此优先使用新增操作的工作流ID。

### 实时同步场景（CDC）
对于实时同步，系统采用智能选择策略：

```
根据数据变化的操作类型选择：
- INSERT操作 → 使用 coze_workflow_id_insert
- UPDATE操作 → 使用 coze_workflow_id_update  
- DELETE操作 → 使用 coze_workflow_id_delete
- 混合操作 → 优先使用 INSERT 对应的工作流ID
```

## 常见问题排查

### 问题1：手动同步显示失败

**可能原因**：
- 没有设置任何有效的工作流ID
- 同步配置未启用
- 网络连接问题
- Coze API密钥无效

**解决方案**：
1. 检查同步配置中是否设置了至少一个工作流ID
2. 确保同步配置的"启用"开关已打开
3. 验证网络连接和API密钥有效性

### 问题2：同步了错误的工作流

**可能原因**：
- 工作流ID设置错误
- 选择了不合适的工作流ID

**解决方案**：
1. 确认每个操作类型对应的工作流ID是否正确
2. 根据需要调整工作流ID的优先级设置

### 问题3：部分数据未同步

**可能原因**：
- 字段筛选配置问题
- 数据过滤条件不匹配

**解决方案**：
1. 检查同步配置中的字段筛选设置
2. 验证数据是否符合同步条件

## 最佳实践建议

### 1. 工作流ID设置
- **新增操作**：设置 `coze_workflow_id_insert` 用于处理新增数据
- **更新操作**：设置 `coze_workflow_id_update` 用于处理数据更新
- **删除操作**：设置 `coze_workflow_id_delete` 用于处理数据删除
- **兼容性**：保留 `coze_workflow_id` 用于向后兼容

### 2. 测试验证
- 在正式使用前，先进行小批量数据同步测试
- 验证每个操作类型的工作流是否正确执行
- 检查同步后的数据完整性和准确性

### 3. 监控维护
- 定期检查同步配置的状态
- 监控同步任务的执行日志
- 及时处理同步失败的情况

## 总结

通过上述修复，手动同步功能现在能够正确处理三个独立工作流ID的配置。系统会根据配置情况智能选择最合适的工作流ID，确保数据同步的准确性和可靠性。

如果在使用过程中遇到任何问题，请参考本文档的"常见问题排查"部分，或查看系统的详细日志输出以获取更多调试信息。