# 数据库迁移说明

## 概述

本项目使用Alembic作为数据库迁移工具，用于管理数据库架构的版本控制。Alembic可以自动检测模型变更并生成迁移脚本，确保数据库架构与代码同步。

## 迁移系统配置

### 配置文件
- `alembic.ini` - Alembic主配置文件
- `migrations/env.py` - 迁移环境配置
- `migrations/versions/` - 迁移脚本目录

### 数据库连接配置
在 `alembic.ini` 中配置数据库连接：
```ini
sqlalchemy.url = mysql+pymysql://root:Xiaochuan123!@localhost/xiaochuanERP
```

### 模型导入配置
在 `migrations/env.py` 中配置模型导入：
```python
# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# 导入项目的Base模型
from app.core.database import Base
target_metadata = Base.metadata
```

## 迁移命令

### 基本命令

#### 查看当前迁移状态
```bash
alembic current
```

#### 查看迁移历史
```bash
alembic history
```

#### 查看迁移历史（详细）
```bash
alembic history --verbose
```

#### 查看特定迁移的详细信息
```bash
alembic show <revision_id>
```

### 迁移操作

#### 生成新的迁移脚本
```bash
alembic revision --autogenerate -m "描述变更内容"
```

#### 应用所有未应用的迁移
```bash
alembic upgrade head
```

#### 应用到特定版本
```bash
alembic upgrade <revision_id>
```

#### 回滚一个版本
```bash
alembic downgrade -1
```

#### 回滚到特定版本
```bash
alembic downgrade <revision_id>
```

#### 标记当前数据库状态
```bash
alembic stamp head
```

#### 标记到特定版本
```bash
alembic stamp <revision_id>
```

## 迁移流程

### 1. 开发新功能时的迁移流程

1. **修改数据模型**
   - 在 `app/models/` 目录下修改或创建新的模型类

2. **生成迁移脚本**
   ```bash
   alembic revision --autogenerate -m "添加新功能表"
   ```

3. **检查生成的迁移脚本**
   - 查看 `migrations/versions/` 目录下新生成的迁移文件
   - 确保迁移脚本正确反映了模型变更

4. **应用迁移**
   ```bash
   alembic upgrade head
   ```

5. **测试迁移结果**
   - 验证数据库架构变更
   - 测试相关功能

### 2. 生产环境部署流程

1. **备份生产数据库**
   ```bash
   mysqldump -u root -p xiaochuanERP > backup_$(date +%Y%m%d).sql
   ```

2. **检查迁移状态**
   ```bash
   alembic current
   ```

3. **应用迁移**
   ```bash
   alembic upgrade head
   ```

4. **验证迁移结果**
   - 检查数据库架构
   - 验证应用功能

### 3. 回滚流程

1. **查看迁移历史**
   ```bash
   alembic history
   ```

2. **回滚迁移**
   ```bash
   alembic downgrade -1
   # 或回滚到特定版本
   alembic downgrade <revision_id>
   ```

3. **验证回滚结果**
   - 检查数据库架构是否恢复
   - 验证应用功能

## 迁移脚本结构

### 迁移文件示例
```python
"""添加用户表

Revision ID: abc123def456
Revises: previous_revision_id
Create Date: 2025-10-17 22:54:28.994312

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# 修订标识符
revision: str = 'abc123def456'
down_revision: Union[str, None] = 'previous_revision_id'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """升级架构"""
    # 创建表
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(length=50), nullable=False),
        sa.Column('email', sa.String(length=100), nullable=False),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('username'),
        sa.UniqueConstraint('email')
    )
    
    # 创建索引
    op.create_index('idx_users_username', 'users', ['username'])


def downgrade() -> None:
    """降级架构"""
    # 删除索引
    op.drop_index('idx_users_username', table_name='users')
    
    # 删除表
    op.drop_table('users')
```

### 常用操作

#### 创建表
```python
op.create_table('table_name',
    sa.Column('id', sa.Integer(), primary_key=True),
    sa.Column('name', sa.String(100), nullable=False)
)
```

#### 删除表
```python
op.drop_table('table_name')
```

#### 添加列
```python
op.add_column('table_name', sa.Column('new_column', sa.String(100)))
```

#### 删除列
```python
op.drop_column('table_name', 'column_name')
```

#### 创建索引
```python
op.create_index('index_name', 'table_name', ['column_name'])
```

#### 删除索引
```python
op.drop_index('index_name', table_name='table_name')
```

#### 添加外键约束
```python
op.create_foreign_key('fk_name', 'source_table', 'target_table', ['source_column'], ['target_column'])
```

## 最佳实践

### 1. 迁移脚本编写规范

- **描述性迁移名称**：使用清晰的描述说明迁移内容
- **原子性操作**：每个迁移脚本应该是原子的
- **可逆性**：确保 `downgrade` 方法正确实现
- **测试迁移**：在应用前测试迁移脚本

### 2. 团队协作规范

- **版本控制**：所有迁移脚本必须提交到版本控制
- **顺序执行**：迁移脚本按时间顺序执行，不要修改已提交的迁移
- **冲突解决**：如果出现迁移冲突，协调解决并生成新的迁移

### 3. 生产环境规范

- **备份优先**：应用迁移前必须备份数据库
- **维护窗口**：在低流量时段执行迁移
- **监控验证**：迁移后验证系统功能

## 故障排除

### 常见问题

#### 1. 迁移失败
**症状**：`alembic upgrade head` 失败
**解决**：
- 检查迁移脚本语法
- 验证数据库连接
- 查看详细错误信息

#### 2. 模型变更未检测到
**症状**：Alembic未生成预期的迁移脚本
**解决**：
- 检查模型类是否正确继承Base
- 验证 `target_metadata` 配置
- 检查模型导入路径

#### 3. 迁移版本冲突
**症状**：迁移历史中出现版本冲突
**解决**：
- 协调团队成员解决冲突
- 可能需要手动调整迁移顺序

### 调试技巧

#### 启用详细日志
```bash
alembic --verbose upgrade head
```

#### 检查迁移脚本
```bash
# 查看迁移脚本内容
cat migrations/versions/<revision_id>_migration_name.py
```

#### 验证数据库状态
```sql
-- 查看Alembic版本表
SELECT * FROM alembic_version;

-- 查看表结构
DESCRIBE table_name;
```

## 相关文件说明

### 迁移相关文件

- `migrations/script.py.mako` - 迁移脚本模板
- `migrations/README` - 迁移系统说明
- `migrations/versions/` - 所有迁移脚本

### 项目配置文件

- `app/core/database.py` - 数据库连接和Base模型
- `app/models/` - 所有数据模型定义
- `requirements.txt` - 包含Alembic依赖

## 扩展功能

### 数据迁移
除了架构迁移，还可以进行数据迁移：
```python
def upgrade():
    # 架构变更
    op.add_column('users', sa.Column('status', sa.String(20)))
    
    # 数据迁移
    connection = op.get_bind()
    connection.execute(
        sa.text("UPDATE users SET status = 'active' WHERE status IS NULL")
    )
```

### 条件迁移
根据数据库类型执行不同的迁移：
```python
def upgrade():
    if op.get_context().dialect.name == 'mysql':
        # MySQL特定操作
        op.execute("ALTER TABLE users ENGINE=InnoDB")
    elif op.get_context().dialect.name == 'postgresql':
        # PostgreSQL特定操作
        op.execute("ALTER TABLE users SET SCHEMA public")
```

---

*最后更新：2025年10月17日*